suite: test deployment
tests:
  - it: Minimal manifest should match snapshot
    templates:
      - deployment.yaml
      - pod-disruption-budget.yaml
      - service.yaml
    set:
      image: nginx
      tag: latest
    asserts:
      - matchSnapshot: { }
  - it: should render default with PodDisruptionBudget and should match snapshot
    templates:
      - pod-disruption-budget.yaml
    asserts:
      - matchSnapshot: { }
      - isKind:
          of: PodDisruptionBudget
  - it: should be possible to render without PodDisruptionBudget
    templates:
      - pod-disruption-budget.yaml
    set:
      createPodDisruptionBudget: false
    asserts:
      - hasDocuments:
          count: 0
  - it: Full manifest should match snapshot
    templates:
      - config-map.yaml
      - deployment.yaml
      - ingress.yaml
      - pod-disruption-budget.yaml
      - service.yaml
      - nginx-config-override-files.yaml
    set:
      replicas: 3
      minAvailableReplicas: 1
      image: wordpress
      tag: greatest
      deploymentAnnotations:
        key1: value1
        key2: value2
      resourceName: "frontend1"
      config:
        root:
          key1: value1
          key2: value2
      secretRefs:
        - secret1
      configMapRefs:
        - configMap1
      ingress_host: example.com
      ingress_path: /example
      port: 80
      memory_request: "4Mi"
      memory_limit: "19Mi"
      cpu_request: "0.3"
      cpu_limit: "1"
      templateConfigOverrides:
        example-locations.conf.template: |-
          location ~* \.(css|js)$ {
            expires 30d;
          }
          
          location /api/upload/stuff {
            client_max_body_size 200M;
            proxy_ssl_server_name on;
            proxy_pass ${LOC_API_PROXY_PASS_HOST};
          }
        example-cache.conf.template: |-
          proxy_cache_path /tmp/example_cache levels=1:2 keys_zone=example_cache:10m inactive=60m use_temp_path=off;
          proxy_cache_key "$scheme$request_method$host$request_uri";
          proxy_cache_methods GET HEAD;
          proxy_cache_valid 200 10m;
          proxy_cache_use_stale updating;
          proxy_cache_background_update on;
          proxy_cache example_cache;
        example-server.conf.template: |-
          gzip on;
          gzip_comp_level 5;
          gzip_vary on;
          gzip_min_length 1024;
          gzip_proxied any;
    asserts:
      - matchSnapshot: { }
